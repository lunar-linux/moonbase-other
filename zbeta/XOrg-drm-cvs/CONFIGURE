# only lin -r will trigger the driver chooser
if [ -n "$DRM_MODULES" ] || [ -n "$RECONFIGURE" ] || query "Select DRM drivers to build?" n ; then        
    ALL_DRM_MODULES=$(cat $SCRIPT_DIRECTORY/drivers | cut -d: -f1)
    DRM_MODULES=$(get_module_config DRM_MODULES)
    if [ -z "$DRM_MODULES" ]; then
        DRM_MODULES=$(grep ':on$' $SCRIPT_DIRECTORY/drivers | cut -d: -f1)
    fi
    
    # if it's empty we just enable all
    list_xorg_drivers()
    {
      (
        unset IFS
        for DRIVER in $ALL_DRM_MODULES; do
            echo $DRIVER
            echo $(grep ^$DRIVER: $SCRIPT_DIRECTORY/drivers | cut -d: -f2)
            if echo $DRM_MODULES | grep -qw $DRIVER; then
                echo on
            else
                echo off
            fi
        done
      )
    }

    IFS="$TAB_ENTER_IFS" DRM_MODULES=`dialog --backtitle "XOrg DRM driver selection" --stdout --separate-output --checklist "Key:  [X] = on, [ ] = off" 0 0 0 $(list_xorg_drivers)`
    # hack to strip newlines
    set_module_config DRM_MODULES "$(echo $DRM_MODULES)"
fi
