default_pre_build &&

unzip $SOURCE_CACHE/$SOURCE2 &&

# https://crbug.com/skia/6663#c10
patch_it $SOURCE3 0 &&

# Load widevine cdm
patch_it $SOURCE4 1 &&

# Remove unsupported compiler flags
sedit '/"-Wno-defaulted-function-deleted"/d' build/config/compiler/BUILD.gn &&

# Make sure python2 is used
# chromium has there own guards for it, but this one breaks
sedit '1s;python$;&2;' third_party/dom_distiller_js/protoc_plugins/*.py &&
sedit '/proto_library(/ a   run_under_python2 = true' third_party/dom_distiller_js/BUILD.gn &&

# ../../components/viz/service/display/delegated_ink_point_renderer_base.h:92:54:
# error: field has incomplete type 'viz::DelegatedInkTrailData'
# note: in instantiation of template class 'std::unordered_map<int, viz::DelegatedInkTrailData, ...>' requested here
sedit '/include.*viz_service_export\.h/ a #include "components/viz/service/display/delegated_ink_trail_data.h"' components/viz/service/display/delegated_ink_point_renderer_base.h &&

# ../../ui/accessibility/ax_tree_serializer.h:652
# missing declaration of std::time, did you mean `time`?
sedit '/include <vector>/ a #include <ctime>' ui/accessibility/ax_tree_serializer.h &&

# ../../components/autofill/core/browser/data_model/contact_info.h:108:14:
# error: no template named 'unique_ptr' in namespace 'std'
sedit '/include <vector>/ a #include <memory>' components/autofill/core/browser/data_model/contact_info.h &&

# Build requires nodejs / use the system version
mkdir -p third_party/node/linux/node-linux-x64/bin &&
ln -s /usr/bin/node third_party/node/linux/node-linux-x64/bin/node &&

export CHROMIUM_HOME=/usr/lib/$MODULE &&

# Google API keys (see http://www.chromium.org/developers/how-tos/api-keys)
# The keys below are for Lunar Linux use ONLY. If you are maintaining chromium for
# another distribution, please get your own set of keys.
google_api_key=AIzaSyDhObDIVsBGV5fleLgLq6ZpfKldIVMvrG4 &&
google_default_client_id=1081365520390-t7vsmo6kde87fvbjoue2ea412vsjkvu0.apps.googleusercontent.com &&
google_default_client_secret=mz6fvViZFucQ5QVggWaqOjYX &&

local _flags=(
  'custom_toolchain="//build/toolchain/linux/unbundle:default"'
  'host_toolchain="//build/toolchain/linux/unbundle:default"'
  'is_official_build=true'
  'chrome_pgo_phase=0'
  'is_clang=true'
  'use_lld=true'
  'use_gold=false'
#  'is_component_build=true'
  'clang_use_chrome_plugins=false'
  'treat_warnings_as_errors=false'
  'fieldtrial_testing_like_official_build=true'
  'ffmpeg_branding="Chrome"'
  'proprietary_codecs=true'
  'use_gnome_keyring=false'
  'use_sysroot=false'
  'use_custom_libcxx=false'
  'enable_hangout_services_extension=true'
  'enable_widevine=true'
  'enable_nacl=false'
  'enable_swiftshader=false'
  'symbol_level=0'
  "google_api_key=\"${google_api_key}\""
  "google_default_client_id=\"${google_default_client_id}\""
  "google_default_client_secret=\"${google_default_client_secret}\""
) &&

for o in $OPTS; do
  _flags+=( "$o" )
done &&

export CC=clang &&
export CXX=clang++ &&
export AR=llvm-ar &&
export NM=nm &&

# Facilitate deterministic builds (taken from build/config/compiler/BUILD.gn)
export CFLAGS+='   -Wno-builtin-macro-redefined' &&
export CXXFLAGS+=' -Wno-builtin-macro-redefined' &&
export CPPFLAGS+=' -D__DATE__=  -D__TIME__=  -D__TIMESTAMP__=' &&

# Silence unknown warning options
CFLAGS+=' -Wno-unknown-warning-option' &&
CXXFLAGS+=' -Wno-unknown-warning-option' &&

gn gen out/Release --args="${_flags[*]}" --script-executable=/usr/bin/python3
