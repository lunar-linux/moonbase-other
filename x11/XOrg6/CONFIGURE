# only lin -r will trigger the driver chooser

if [ -n "$RECONFIGURE" ] || query "Select specific video drivers to build?" n ; then        
    ALL_XORG_DRIVERS=$(cat $SCRIPT_DIRECTORY/drivers | cut -d: -f1)
    XORG_DRIVERS=$(get_module_config XORG_DRIVERS)
    if [ -z "$XORG_DRIVERS" ]; then
        XORG_DRIVERS=$(grep ':on$' $SCRIPT_DIRECTORY/drivers | cut -d: -f1)
    fi
    
    # if it's empty we just enable all
    list_xorg_drivers()
    {
      (
        unset IFS
        for DRIVER in $ALL_XORG_DRIVERS; do
            echo $DRIVER
            echo $(grep ^$DRIVER: $SCRIPT_DIRECTORY/drivers | cut -d: -f2)
            if echo $XORG_DRIVERS | grep -qw $DRIVER; then
                echo on
            else
                echo off
            fi
        done
      )
    }

    IFS="$TAB_ENTER_IFS" XORG_DRIVERS=`dialog --backtitle "XOrg video driver selection" --stdout --separate-output --checklist "Key:  [X] = on, [ ] = off" 0 0 0 $(list_xorg_drivers)`
    # hack to strip newlines
    set_module_config XORG_DRIVERS "$(echo $XORG_DRIVERS)"
fi
